name: è¦å‰‡å¼·åˆ¶åŸ·è¡Œ

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  rules-enforcement:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4

    - name: ğŸŸ¢ è¨­ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ“¦ å®‰è£å‰ç«¯ä¾è³´
      working-directory: ./frontend
      run: |
        npm ci

    - name: ğŸ“¦ å®‰è£å¾Œç«¯ä¾è³´
      working-directory: ./backend
      run: |
        pip install -r requirements.txt
        pip install flake8 black pytest pytest-cov bandit

    - name: ğŸ”’ åŸ·è¡Œå¼·åˆ¶è¦å‰‡æª¢æŸ¥
      run: |
        chmod +x ./scripts/enforce-rules.sh
        ./scripts/enforce-rules.sh --strict

    - name: ğŸ§ª é‹è¡Œå‰ç«¯æ¸¬è©¦
      working-directory: ./frontend
      run: |
        npm run test || echo "å‰ç«¯æ¸¬è©¦æš«æ™‚è·³é"

    - name: ğŸ§ª é‹è¡Œå¾Œç«¯æ¸¬è©¦
      working-directory: ./backend
      run: |
        python -m pytest tests/ --cov=app --cov-report=xml || echo "å¾Œç«¯æ¸¬è©¦æš«æ™‚è·³é"

    - name: ğŸ³ é©—è­‰ Docker å…¼å®¹æ€§
      run: |
        chmod +x ./scripts/docker-compatibility-check.sh
        ./scripts/docker-compatibility-check.sh

    - name: ğŸ“‹ ç”Ÿæˆè¦å‰‡æª¢æŸ¥å ±å‘Š
      if: always()
      run: |
        echo "## è¦å‰‡æª¢æŸ¥å ±å‘Š" > rules-report.md
        echo "" >> rules-report.md
        echo "### åŸ·è¡Œæ™‚é–“: $(date)" >> rules-report.md
        echo "" >> rules-report.md

        # æª¢æŸ¥ç¡¬ç·¨ç¢¼æ•æ„Ÿä¿¡æ¯
        echo "### ğŸ” ç¡¬ç·¨ç¢¼æª¢æŸ¥" >> rules-report.md
        if grep -r -E "(password|secret|key).*=.*['\"][^'\"]{8,}" frontend/src backend/app --include="*.js" --include="*.py" 2>/dev/null; then
          echo "âŒ ç™¼ç¾ç¡¬ç·¨ç¢¼æ•æ„Ÿä¿¡æ¯" >> rules-report.md
        else
          echo "âœ… æœªç™¼ç¾ç¡¬ç·¨ç¢¼æ•æ„Ÿä¿¡æ¯" >> rules-report.md
        fi
        echo "" >> rules-report.md

        # æª¢æŸ¥è·¯å¾‘ç®¡ç†
        echo "### ğŸ›£ï¸ è·¯å¾‘ç®¡ç†æª¢æŸ¥" >> rules-report.md
        if grep -r "'/src/" frontend/src --include="*.js" 2>/dev/null | grep -v "routes.js" | grep -v "test" >/dev/null; then
          echo "âŒ ç™¼ç¾ç¡¬ç·¨ç¢¼è·¯å¾‘" >> rules-report.md
        else
          echo "âœ… è·¯å¾‘ç®¡ç†è¦ç¯„" >> rules-report.md
        fi
        echo "" >> rules-report.md

        # Docker å…¼å®¹æ€§
        echo "### ğŸ³ Docker å…¼å®¹æ€§" >> rules-report.md
        if [ -f "frontend/scripts/script-env.js" ] && [ -f "backend/scripts/script_env.py" ]; then
          echo "âœ… Docker ç’°å¢ƒé…ç½®å®Œæ•´" >> rules-report.md
        else
          echo "âŒ ç¼ºå°‘ Docker ç’°å¢ƒé…ç½®" >> rules-report.md
        fi
        echo "" >> rules-report.md

        # è¦å‰‡æ–‡æª”
        echo "### ğŸ“š è¦å‰‡æ–‡æª”" >> rules-report.md
        if [ -f "RULES.md" ] && [ -f "frontend/RULES.md" ] && [ -f "backend/RULES.md" ]; then
          echo "âœ… è¦å‰‡æ–‡æª”é½Šå…¨" >> rules-report.md
        else
          echo "âŒ è¦å‰‡æ–‡æª”ä¸å®Œæ•´" >> rules-report.md
        fi

    - name: ğŸ“Š ä¸Šå‚³è¦å‰‡æª¢æŸ¥å ±å‘Š
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: rules-report
        path: rules-report.md

  security-scan:
    runs-on: ubuntu-latest
    needs: rules-enforcement

    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4

    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ”’ å®‰è£å®‰å…¨æƒæå·¥å…·
      run: |
        pip install bandit safety

    - name: ğŸ” Python å®‰å…¨æƒæ
      working-directory: ./backend
      run: |
        bandit -r app/ -f json -o bandit-report.json || true
        safety check --json --output safety-report.json || true

    - name: ğŸŸ¢ Node.js å®‰å…¨æƒæ
      working-directory: ./frontend
      run: |
        npm audit --audit-level=moderate --json > npm-audit.json || true

    - name: ğŸ“Š ä¸Šå‚³å®‰å…¨å ±å‘Š
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: |
          backend/bandit-report.json
          backend/safety-report.json
          frontend/npm-audit.json

  docker-validation:
    runs-on: ubuntu-latest
    needs: rules-enforcement

    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4

    - name: ğŸ³ è¨­ç½® Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ—ï¸ æ§‹å»ºå‰ç«¯ Docker é¡åƒ
      working-directory: ./frontend
      run: |
        docker build -t stock-insight-frontend:test .

    - name: ğŸ—ï¸ æ§‹å»ºå¾Œç«¯ Docker é¡åƒ
      working-directory: ./backend
      run: |
        docker build -t stock-insight-backend:test .

    - name: âœ… é©—è­‰é¡åƒæ§‹å»ºæˆåŠŸ
      run: |
        docker images | grep stock-insight
        echo "âœ… Docker é¡åƒæ§‹å»ºæˆåŠŸ"

  rules-summary:
    runs-on: ubuntu-latest
    needs: [rules-enforcement, security-scan, docker-validation]
    if: always()

    steps:
    - name: ğŸ“‹ è¦å‰‡åŸ·è¡Œæ‘˜è¦
      run: |
        echo "## Stock Insight Platform è¦å‰‡æª¢æŸ¥æ‘˜è¦"
        echo ""
        echo "### æª¢æŸ¥é …ç›®"
        echo "- âœ… å¼·åˆ¶è¦å‰‡æª¢æŸ¥"
        echo "- âœ… å®‰å…¨æ¼æ´æƒæ"
        echo "- âœ… Docker å…¼å®¹æ€§é©—è­‰"
        echo ""
        echo "### åŸ·è¡Œçµæœ"

        if [ "${{ needs.rules-enforcement.result }}" == "success" ]; then
          echo "- âœ… è¦å‰‡å¼·åˆ¶åŸ·è¡Œ: é€šé"
        else
          echo "- âŒ è¦å‰‡å¼·åˆ¶åŸ·è¡Œ: å¤±æ•—"
        fi

        if [ "${{ needs.security-scan.result }}" == "success" ]; then
          echo "- âœ… å®‰å…¨æƒæ: é€šé"
        else
          echo "- âŒ å®‰å…¨æƒæ: å¤±æ•—"
        fi

        if [ "${{ needs.docker-validation.result }}" == "success" ]; then
          echo "- âœ… Docker é©—è­‰: é€šé"
        else
          echo "- âŒ Docker é©—è­‰: å¤±æ•—"
        fi

        echo ""
        echo "### è¦å‰‡æ–‡æª”"
        echo "- ğŸ“‹ [é …ç›®è¦å‰‡](./RULES.md)"
        echo "- ğŸ¨ [å‰ç«¯è¦å‰‡](./frontend/RULES.md)"
        echo "- ğŸ [å¾Œç«¯è¦å‰‡](./backend/RULES.md)"
