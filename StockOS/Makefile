# StockOS Makefile
# Áî®ÊñºÁ∑®Ë≠ØÊÑèË≠òÂÆπÂô®Á≥ªÁµ±ÂíåÈÅãË°åÊ∏¨Ë©¶

CC = gcc
CFLAGS = -Wall -Wextra -std=c99 -g -O2
INCLUDES = -I./src
LIBS = -lm

# ÁõÆÈåÑ
SRC_DIR = src
TEST_DIR = tests
BUILD_DIR = build
DOCS_DIR = docs

# Ê∫êÊñá‰ª∂
CONSCIOUSNESS_SOURCES = $(SRC_DIR)/consciousness/consciousness_container.c
TEST_SOURCES = $(TEST_DIR)/test_consciousness_container.c
DEMO_SOURCES = $(TEST_DIR)/demo_consciousness_usage.c

# ÁõÆÊ®ôÊñá‰ª∂
CONSCIOUSNESS_OBJECTS = $(CONSCIOUSNESS_SOURCES:.c=.o)
TEST_OBJECTS = $(TEST_SOURCES:.c=.o)
DEMO_OBJECTS = $(DEMO_SOURCES:.c=.o)

# ÂèØÂü∑Ë°åÊñá‰ª∂
TEST_EXECUTABLE = $(BUILD_DIR)/test_consciousness_container
DEMO_EXECUTABLE = $(BUILD_DIR)/demo_consciousness_usage
CONSCIOUSNESS_LIB = $(BUILD_DIR)/libconsciousness.a

# ÈªòË™çÁõÆÊ®ô
all: build_dir consciousness_lib test_consciousness demo_consciousness

# ÂâµÂª∫ÊßãÂª∫ÁõÆÈåÑ
build_dir:
	@mkdir -p $(BUILD_DIR)
	@echo "üìÅ Created build directory"

# Á∑®Ë≠ØÊÑèË≠òÂÆπÂô®Â∫´
consciousness_lib: build_dir $(CONSCIOUSNESS_OBJECTS)
	@echo "üß† Building consciousness library..."
	ar rcs $(CONSCIOUSNESS_LIB) $(CONSCIOUSNESS_OBJECTS)
	@echo "‚úÖ Consciousness library built: $(CONSCIOUSNESS_LIB)"

# Á∑®Ë≠ØÊ∏¨Ë©¶
test_consciousness: consciousness_lib $(TEST_OBJECTS)
	@echo "üß™ Building consciousness tests..."
	$(CC) $(CFLAGS) $(INCLUDES) $(TEST_OBJECTS) $(CONSCIOUSNESS_LIB) $(LIBS) -o $(TEST_EXECUTABLE)
	@echo "‚úÖ Consciousness tests built: $(TEST_EXECUTABLE)"

# Á∑®Ë≠ØÊºîÁ§∫Á®ãÂ∫è
demo_consciousness: consciousness_lib $(DEMO_OBJECTS)
	@echo "üé≠ Building consciousness demo..."
	$(CC) $(CFLAGS) $(INCLUDES) $(DEMO_OBJECTS) $(CONSCIOUSNESS_LIB) $(LIBS) -o $(DEMO_EXECUTABLE)
	@echo "‚úÖ Consciousness demo built: $(DEMO_EXECUTABLE)"

# ÈÅãË°åÊ∏¨Ë©¶
test: test_consciousness
	@echo "üöÄ Running consciousness container tests..."
	@$(TEST_EXECUTABLE)

# ÈÅãË°åÊ∏¨Ë©¶‰∏¶È°ØÁ§∫Ë©≥Á¥∞Ëº∏Âá∫
test_verbose: test_consciousness
	@echo "üöÄ Running consciousness container tests (verbose)..."
	@$(TEST_EXECUTABLE) 2>&1 | tee test_output.log

# ÈÅãË°åÊºîÁ§∫Á®ãÂ∫è
demo: demo_consciousness
	@echo "üé≠ Running consciousness container demo..."
	@$(DEMO_EXECUTABLE)

# ÈÅãË°åÊºîÁ§∫Á®ãÂ∫è‰∏¶È°ØÁ§∫Ë©≥Á¥∞Ëº∏Âá∫
demo_verbose: demo_consciousness
	@echo "üé≠ Running consciousness container demo (verbose)..."
	@$(DEMO_EXECUTABLE) 2>&1 | tee demo_output.log

# Ê∏ÖÁêÜ
clean:
	@echo "üßπ Cleaning build files..."
	rm -rf $(BUILD_DIR)
	rm -f $(CONSCIOUSNESS_OBJECTS) $(TEST_OBJECTS) $(DEMO_OBJECTS)
	rm -f test_output.log demo_output.log
	@echo "‚úÖ Clean complete"

# ÂÆâË£ùÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ
install: consciousness_lib
	@echo "üì¶ Installing consciousness library..."
	@mkdir -p /usr/local/lib
	@mkdir -p /usr/local/include/stockos
	cp $(CONSCIOUSNESS_LIB) /usr/local/lib/
	cp $(SRC_DIR)/consciousness/consciousness_container.h /usr/local/include/stockos/
	@echo "‚úÖ Installation complete"

# Âç∏Ëºâ
uninstall:
	@echo "üóëÔ∏è Uninstalling consciousness library..."
	rm -f /usr/local/lib/libconsciousness.a
	rm -f /usr/local/include/stockos/consciousness_container.h
	@echo "‚úÖ Uninstallation complete"

# Ê™¢Êü•‰ª£Á¢ºÈ¢®Ê†º
lint:
	@echo "üîç Running code linting..."
	@if command -v clang-format >/dev/null 2>&1; then \
		clang-format --style=Google -i $(SRC_DIR)/consciousness/*.c $(SRC_DIR)/consciousness/*.h $(TEST_DIR)/*.c; \
		echo "‚úÖ Code formatting complete"; \
	else \
		echo "‚ö†Ô∏è clang-format not found, skipping formatting"; \
	fi

# ÈùúÊÖãÂàÜÊûê
analyze: consciousness_lib
	@echo "üî¨ Running static analysis..."
	@if command -v cppcheck >/dev/null 2>&1; then \
		cppcheck --enable=all --std=c99 $(SRC_DIR)/consciousness/ $(TEST_DIR)/; \
		echo "‚úÖ Static analysis complete"; \
	else \
		echo "‚ö†Ô∏è cppcheck not found, skipping static analysis"; \
	fi

# ÁîüÊàêÊñáÊ™î
docs:
	@echo "üìö Generating documentation..."
	@mkdir -p $(DOCS_DIR)
	@if command -v doxygen >/dev/null 2>&1; then \
		doxygen Doxyfile 2>/dev/null || echo "‚ö†Ô∏è Doxygen configuration not found"; \
		echo "‚úÖ Documentation generated"; \
	else \
		echo "‚ö†Ô∏è Doxygen not found, skipping documentation generation"; \
	fi

# ÊÄßËÉΩÊ∏¨Ë©¶
benchmark: test_consciousness
	@echo "‚ö° Running performance benchmarks..."
	@time $(TEST_EXECUTABLE) > /dev/null 2>&1
	@echo "‚úÖ Benchmark complete"

# Ë®òÊÜ∂È´îÊ™¢Êü•
memcheck: test_consciousness
	@echo "üîç Running memory check..."
	@if command -v valgrind >/dev/null 2>&1; then \
		valgrind --leak-check=full --show-leak-kinds=all --track-origins=yes $(TEST_EXECUTABLE); \
		echo "‚úÖ Memory check complete"; \
	else \
		echo "‚ö†Ô∏è Valgrind not found, skipping memory check"; \
	fi

# Âπ´Âä©
help:
	@echo "StockOS Consciousness Container Build System"
	@echo "============================================="
	@echo ""
	@echo "Available targets:"
	@echo "  all              - Build everything (default)"
	@echo "  consciousness_lib - Build consciousness library only"
	@echo "  test_consciousness - Build tests only"
	@echo "  demo_consciousness - Build demo program only"
	@echo "  test             - Build and run tests"
	@echo "  test_verbose     - Build and run tests with detailed output"
	@echo "  demo             - Build and run demo program"
	@echo "  demo_verbose     - Build and run demo with detailed output"
	@echo "  clean            - Remove all build files"
	@echo "  install          - Install library to system"
	@echo "  uninstall        - Remove library from system"
	@echo "  lint             - Format code with clang-format"
	@echo "  analyze          - Run static analysis with cppcheck"
	@echo "  docs             - Generate documentation with Doxygen"
	@echo "  benchmark        - Run performance benchmarks"
	@echo "  memcheck         - Run memory leak detection"
	@echo "  help             - Show this help message"
	@echo ""
	@echo "Environment variables:"
	@echo "  CC               - C compiler (default: gcc)"
	@echo "  CFLAGS           - Compiler flags"
	@echo "  BUILD_DIR        - Build directory (default: build)"

# ÈÄöÁî®Á∑®Ë≠ØË¶èÂâá
%.o: %.c
	@echo "üî® Compiling $<..."
	@$(CC) $(CFLAGS) $(INCLUDES) -c $< -o $@

# ‰æùË≥¥Èóú‰øÇ
$(SRC_DIR)/consciousness/consciousness_container.o: $(SRC_DIR)/consciousness/consciousness_container.h
$(TEST_DIR)/test_consciousness_container.o: $(SRC_DIR)/consciousness/consciousness_container.h
$(TEST_DIR)/demo_consciousness_usage.o: $(SRC_DIR)/consciousness/consciousness_container.h

# ÂÅΩÁõÆÊ®ô
.PHONY: all build_dir consciousness_lib test_consciousness demo_consciousness test test_verbose demo demo_verbose clean install uninstall lint analyze docs benchmark memcheck help 