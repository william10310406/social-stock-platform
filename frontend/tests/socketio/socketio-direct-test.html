<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Socket.IO å¾Œç«¯å®¢æˆ¶ç«¯æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-container {
            border: 1px solid #ddd;
            padding: 20px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .warning { color: orange; }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a87;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        #log {
            background: #f5f5f5;
            padding: 10px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .status.loading {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
        }
        .status.ready {
            background: #d4edda;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <h1>ğŸ”Œ Socket.IO å¾Œç«¯å®¢æˆ¶ç«¯æ¸¬è©¦</h1>

    <div id="status" class="status loading">
        <strong>ğŸ“¦ æ­£åœ¨è¼‰å…¥å¾Œç«¯æä¾›çš„ Socket.IO å®¢æˆ¶ç«¯...</strong>
    </div>

    <div class="test-container">
        <h2>ä½¿ç”¨å¾Œç«¯è‡ªå‹•æä¾›çš„ Socket.IO å®¢æˆ¶ç«¯</h2>
        <p>é€™å€‹æ¸¬è©¦ç›´æ¥ä½¿ç”¨å¾Œç«¯ Flask-SocketIO è‡ªå‹•æä¾›çš„å®¢æˆ¶ç«¯ï¼Œç¢ºä¿ç‰ˆæœ¬ 100% å…¼å®¹ã€‚</p>
        <button id="testBtn" onclick="testDirectConnection()" disabled>è¼‰å…¥ä¸­...</button>
        <button onclick="clearLog()">æ¸…é™¤æ—¥èªŒ</button>
    </div>

    <div class="test-container">
        <h3>æ¸¬è©¦æ—¥èªŒ</h3>
        <div id="log"></div>
    </div>

    <!-- ä½¿ç”¨èˆ‡ Flask-SocketIO 5.x å®Œå…¨å…¼å®¹çš„å®¢æˆ¶ç«¯ç‰ˆæœ¬ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

    <script>
        let socketIOLoaded = false;

        function updateStatus(message, type = 'loading') {
            const statusDiv = document.getElementById('status');
            const testBtn = document.getElementById('testBtn');

            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = `<strong>${message}</strong>`;

            if (type === 'ready') {
                testBtn.disabled = false;
                testBtn.textContent = 'é–‹å§‹æ¸¬è©¦';
                socketIOLoaded = true;
            } else if (type === 'error') {
                testBtn.disabled = true;
                testBtn.textContent = 'è¼‰å…¥å¤±æ•—';
            }
        }

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('log');
            const className = type || 'info';
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function testDirectConnection() {
            if (!socketIOLoaded) {
                log('âŒ Socket.IO å®¢æˆ¶ç«¯å°šæœªè¼‰å…¥å®Œæˆ', 'error');
                return;
            }

            clearLog();
            log('ğŸš€ é–‹å§‹ Socket.IO å¾Œç«¯å®¢æˆ¶ç«¯æ¸¬è©¦...', 'info');

            try {
                // æª¢æŸ¥ Socket.IO æ˜¯å¦å¯ç”¨
                if (typeof io === 'undefined') {
                    throw new Error('Socket.IO å®¢æˆ¶ç«¯æœªè¼‰å…¥ï¼');
                }

                log(`ğŸ“¦ Socket.IO å®¢æˆ¶ç«¯å·²è¼‰å…¥ï¼Œç‰ˆæœ¬: ${io.protocol || 'unknown'}`, 'info');
                log(`ğŸ”§ ä½¿ç”¨å¾Œç«¯è‡ªå‹•æä¾›çš„å®˜æ–¹å®¢æˆ¶ç«¯`, 'info');

                // ä½¿ç”¨æœ€ç›¸å®¹çš„è¨­å®šï¼Œæ¸›å°‘æœƒè©±å•é¡Œ
                const socket = io('/', {
                    transports: ['polling'],
                    upgrade: false,
                    rememberUpgrade: false,
                    timeout: 30000,
                    forceNew: true,
                    autoConnect: true,
                    reconnection: true,
                    reconnectionAttempts: 3,
                    reconnectionDelay: 1000,
                    randomizationFactor: 0.5
                });

                let connected = false;

                socket.on('connect', function() {
                    connected = true;
                    log('ğŸ‰ Socket.IO é€£æ¥æˆåŠŸï¼', 'success');
                    log(`ğŸ“‹ Session ID: ${socket.id}`, 'info');
                    log(`ğŸš€ å‚³è¼¸æ–¹å¼: ${socket.io.engine.transport.name}`, 'info');
                    log(`ğŸ”— Protocol Version: ${socket.io.protocol || 'N/A'}`, 'info');
                    log(`ğŸ”§ é€£æ¥ç‹€æ…‹: ${socket.connected ? 'å·²é€£æ¥' : 'æœªé€£æ¥'}`, 'info');

                    // ç­‰å¾…ä¸€ä¸‹å†ç™¼é€æ¶ˆæ¯ï¼Œç¢ºä¿é€£æ¥ç©©å®š
                    setTimeout(() => {
                        // ç™¼é€æ¸¬è©¦æ¶ˆæ¯
                        socket.emit('ping', { message: 'å¾Œç«¯å®¢æˆ¶ç«¯æ¸¬è©¦', timestamp: new Date().toISOString() });
                        log('ğŸ“¤ ç™¼é€ ping æ¸¬è©¦', 'info');

                        socket.emit('test_message', { message: 'å¾Œç«¯å®¢æˆ¶ç«¯é€£æ¥æ¸¬è©¦æˆåŠŸï¼' });
                        log('ğŸ“¤ ç™¼é€æ¸¬è©¦æ¶ˆæ¯', 'info');

                        // åŠ å…¥èŠå¤©å®¤
                        socket.emit('join_chat', { room: 'backend_test_room', user: 'backend_test_user' });
                        log('ğŸ“¤ åŠ å…¥å¾Œç«¯æ¸¬è©¦èŠå¤©å®¤', 'info');
                    }, 500);
                });

                socket.on('pong', function(data) {
                    log(`ğŸ“ æ”¶åˆ° pong: ${JSON.stringify(data)}`, 'success');
                });

                socket.on('connection_status', function(data) {
                    log(`ğŸ“¡ é€£æ¥ç‹€æ…‹: ${JSON.stringify(data)}`, 'success');
                });

                socket.on('test_response', function(data) {
                    log(`ğŸ“¨ æ¸¬è©¦å›æ‡‰: ${JSON.stringify(data)}`, 'success');
                });

                socket.on('user_joined', function(data) {
                    log(`ğŸ‘‹ ç”¨æˆ¶åŠ å…¥: ${JSON.stringify(data)}`, 'success');
                });

                socket.on('message', function(data) {
                    log(`ğŸ’¬ æ”¶åˆ°æ¶ˆæ¯: ${JSON.stringify(data)}`, 'success');
                });

                socket.on('connect_error', function(error) {
                    log(`âŒ é€£æ¥éŒ¯èª¤: ${error.message}`, 'error');
                    log(`éŒ¯èª¤è©³æƒ…: ${JSON.stringify(error)}`, 'error');
                    log(`éŒ¯èª¤é¡å‹: ${error.type || 'unknown'}`, 'error');
                });

                socket.on('disconnect', function(reason) {
                    log(`ğŸ”Œ é€£æ¥æ–·é–‹: ${reason}`, 'warning');
                    connected = false;
                });

                socket.on('reconnect', function(attemptNumber) {
                    log(`ğŸ”„ é‡æ–°é€£æ¥æˆåŠŸ (å˜—è©¦ ${attemptNumber})`, 'success');
                });

                socket.on('reconnect_attempt', function(attemptNumber) {
                    log(`ğŸ”„ å˜—è©¦é‡æ–°é€£æ¥ ${attemptNumber}`, 'info');
                });

                socket.on('reconnect_error', function(error) {
                    log(`âŒ é‡é€£éŒ¯èª¤: ${error.message}`, 'error');
                });

                socket.on('error', function(error) {
                    log(`âš ï¸ Socket éŒ¯èª¤: ${error}`, 'error');
                });

                // ç›£è½å‚³è¼¸å‡ç´š
                socket.io.on('upgrade', function() {
                    log(`â¬†ï¸ å‚³è¼¸å‡ç´šåˆ°: ${socket.io.engine.transport.name}`, 'info');
                });

                // 10ç§’å¾Œæª¢æŸ¥ç‹€æ…‹
                setTimeout(() => {
                    if (connected) {
                        log('âœ… å¾Œç«¯å®¢æˆ¶ç«¯æ¸¬è©¦æˆåŠŸï¼', 'success');
                        log('ğŸ’¡ é€™è­‰æ˜ä½¿ç”¨å¾Œç«¯å®˜æ–¹å®¢æˆ¶ç«¯åŠŸèƒ½æ­£å¸¸', 'success');

                        // æ¸¬è©¦å®Œæˆå¾Œæ–·é–‹
                        setTimeout(() => {
                            socket.disconnect();
                            log('âœ… æ¸¬è©¦å®Œæˆï¼Œé€£æ¥å·²æ–·é–‹', 'info');
                        }, 3000);
                    } else {
                        log('âŒ å¾Œç«¯å®¢æˆ¶ç«¯æ¸¬è©¦å¤±æ•—', 'error');
                    }
                }, 10000);

            } catch (error) {
                log(`âŒ æ¸¬è©¦åˆå§‹åŒ–å¤±æ•—: ${error.message}`, 'error');
                log(`éŒ¯èª¤å †æ£§: ${error.stack}`, 'error');
            }
        }

        // æª¢æŸ¥ Socket.IO è¼‰å…¥ç‹€æ…‹
        function checkSocketIOLoaded() {
            if (typeof io !== 'undefined') {
                updateStatus('âœ… Socket.IO å¾Œç«¯å®¢æˆ¶ç«¯è¼‰å…¥æˆåŠŸï¼', 'ready');
                log('ğŸ“„ é é¢è¼‰å…¥å®Œæˆ', 'info');
                log('ğŸ’¡ é»æ“Š "é–‹å§‹æ¸¬è©¦" æŒ‰éˆ•é€²è¡Œ Socket.IO é€£æ¥æ¸¬è©¦', 'info');
                log('ğŸ”§ æ­¤æ¸¬è©¦ä½¿ç”¨å¾Œç«¯è‡ªå‹•æä¾›çš„å®˜æ–¹ Socket.IO å®¢æˆ¶ç«¯', 'info');
            } else {
                updateStatus('âŒ Socket.IO å¾Œç«¯å®¢æˆ¶ç«¯è¼‰å…¥å¤±æ•—', 'error');
                log('âŒ Socket.IO å¾Œç«¯å®¢æˆ¶ç«¯è¼‰å…¥å¤±æ•—', 'error');
                log('ğŸ’¡ è«‹æª¢æŸ¥å¾Œç«¯æœå‹™æ˜¯å¦æ­£å¸¸é‹è¡Œ', 'error');
            }
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œæª¢æŸ¥
        document.addEventListener('DOMContentLoaded', function() {
            // çµ¦è…³æœ¬è¼‰å…¥ä¸€äº›æ™‚é–“
            setTimeout(checkSocketIOLoaded, 1000);
        });
    </script>
</body>
</html>
