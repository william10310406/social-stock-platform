<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ³ Docker å®Œæ•´æ¸¬è©¦é é¢</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background: #f8f9fa;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header {
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
        }
        .test-section {
            background: white;
            padding: 25px;
            margin: 20px 0;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .test-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        button:hover { transform: translateY(-2px); opacity: 0.9; }

        .log-area {
            background: #1e1e1e;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            line-height: 1.5;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .status-card {
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .status-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .status-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

        .log-success { color: #98FB98; }
        .log-error { color: #FF6B6B; }
        .log-warning { color: #FFD93D; }
        .log-info { color: #6BCFFF; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ³ Docker ç’°å¢ƒå®Œæ•´æ¸¬è©¦</h1>
            <p>Stock Insight Platform - çµ±ä¸€æ¸¬è©¦æ§åˆ¶å°</p>
            <p id="currentTime"></p>
        </div>

        <!-- ç³»çµ±ç‹€æ…‹ç¸½è¦½ -->
        <div class="test-section">
            <h2>ğŸ“Š ç³»çµ±ç‹€æ…‹ç¸½è¦½</h2>
            <div class="status-grid" id="statusGrid">
                <div class="status-card status-info">
                    <strong>Docker å®¹å™¨</strong><br>
                    <span id="dockerStatus">æª¢æ¸¬ä¸­...</span>
                </div>
                <div class="status-card status-info">
                    <strong>API ä»£ç†</strong><br>
                    <span id="proxyStatus">æª¢æ¸¬ä¸­...</span>
                </div>
                <div class="status-card status-info">
                    <strong>æ¨¡çµ„è¼‰å…¥</strong><br>
                    <span id="moduleStatus">æª¢æ¸¬ä¸­...</span>
                </div>
                <div class="status-card status-info">
                    <strong>WebSocket</strong><br>
                    <span id="wsStatus">æª¢æ¸¬ä¸­...</span>
                </div>
            </div>
        </div>

        <!-- æ¸¬è©¦æ§åˆ¶å° -->
        <div class="test-section">
            <h2>ğŸ§ª æ¸¬è©¦æ§åˆ¶å°</h2>
            <div class="test-buttons">
                <button class="btn-primary" onclick="runAllTests()">ğŸš€ é‹è¡Œå…¨éƒ¨æ¸¬è©¦</button>
                <button class="btn-success" onclick="testBasicFunction()">âœ… åŸºæœ¬åŠŸèƒ½</button>
                <button class="btn-warning" onclick="testApiConnection()">ğŸ”— API é€£æ¥</button>
                <button class="btn-info" onclick="testModuleLoad()">ğŸ“¦ æ¨¡çµ„è¼‰å…¥</button>
                <button class="btn-purple" onclick="testWebSocket()">ğŸ”Œ WebSocket</button>
                <button class="btn-secondary" onclick="clearLogs()">ğŸ—‘ï¸ æ¸…é™¤æ—¥èªŒ</button>
            </div>
        </div>

        <!-- æ—¥èªŒè¼¸å‡º -->
        <div class="test-section">
            <h2>ğŸ“ æ¸¬è©¦æ—¥èªŒ</h2>
            <div id="logOutput" class="log-area">ç­‰å¾…æ¸¬è©¦é–‹å§‹...\n</div>
        </div>

        <!-- å¿«é€Ÿå°èˆª -->
        <div class="test-section">
            <h2>ğŸ§­ å¿«é€Ÿå°èˆª</h2>
            <div class="test-buttons">
                <button class="btn-primary" onclick="goToMain()">ğŸ  ä¸»é </button>
                <button class="btn-success" onclick="goToLogin()">ğŸ” ç™»å…¥é </button>
                <button class="btn-warning" onclick="goToDashboard()">ğŸ“Š å„€è¡¨æ¿</button>
            </div>
        </div>
    </div>

    <script type="module">
        // æ—¥èªŒç®¡ç†
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logArea = document.getElementById('logOutput');
            const colorClass = `log-${type}`;

            logArea.innerHTML += `<span class="${colorClass}">[${timestamp}] ${message}</span>\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logOutput').innerHTML = '';
            log('æ—¥èªŒå·²æ¸…é™¤', 'info');
        }

        // ç‹€æ…‹æ›´æ–°
        function updateStatus(elementId, status, type) {
            const element = document.getElementById(elementId);
            element.textContent = status;
            element.parentElement.className = `status-card status-${type}`;
        }

        // åŸºæœ¬åŠŸèƒ½æ¸¬è©¦
        function testBasicFunction() {
            log('ğŸ§ª é–‹å§‹åŸºæœ¬åŠŸèƒ½æ¸¬è©¦...', 'info');

            try {
                // æ•¸å­¸é‹ç®—
                const result = 2 + 2;
                if (result === 4) {
                    log('âœ… æ•¸å­¸é‹ç®—æ­£å¸¸', 'success');
                } else {
                    log('âŒ æ•¸å­¸é‹ç®—ç•°å¸¸', 'error');
                }

                // localStorage
                localStorage.setItem('test', 'value');
                const stored = localStorage.getItem('test');
                if (stored === 'value') {
                    log('âœ… localStorage æ­£å¸¸', 'success');
                    localStorage.removeItem('test');
                } else {
                    log('âŒ localStorage ç•°å¸¸', 'error');
                }

                // DOM æ“ä½œ
                const testDiv = document.createElement('div');
                testDiv.textContent = 'test';
                if (testDiv.textContent === 'test') {
                    log('âœ… DOM æ“ä½œæ­£å¸¸', 'success');
                } else {
                    log('âŒ DOM æ“ä½œç•°å¸¸', 'error');
                }

                log('ğŸ‰ åŸºæœ¬åŠŸèƒ½æ¸¬è©¦å®Œæˆ', 'success');
                updateStatus('dockerStatus', 'âœ… æ­£å¸¸é‹è¡Œ', 'success');

            } catch (error) {
                log(`âŒ åŸºæœ¬åŠŸèƒ½æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                updateStatus('dockerStatus', 'âŒ æ¸¬è©¦å¤±æ•—', 'error');
            }
        }

        // API é€£æ¥æ¸¬è©¦
        async function testApiConnection() {
            log('ğŸ”— é–‹å§‹ API é€£æ¥æ¸¬è©¦...', 'info');

            try {
                // ä½¿ç”¨ä»£ç†è·¯å¾‘ - é€™æ˜¯é—œéµï¼
                const response = await fetch('/api/health', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                if (response.ok) {
                    const data = await response.json();
                    log('âœ… API ä»£ç†é€£æ¥æˆåŠŸ', 'success');
                    log(`ğŸ“Š API ç‹€æ…‹: ${data.status}`, 'success');
                    log(`ğŸ—„ï¸ è³‡æ–™åº«: ${data.database}`, 'info');
                    log(`â° æ™‚é–“æˆ³: ${data.timestamp}`, 'info');

                    updateStatus('proxyStatus', 'âœ… ä»£ç†æ­£å¸¸', 'success');
                } else {
                    log(`âŒ API éŸ¿æ‡‰éŒ¯èª¤: ${response.status} ${response.statusText}`, 'error');
                    updateStatus('proxyStatus', 'âŒ éŸ¿æ‡‰éŒ¯èª¤', 'error');
                }
            } catch (error) {
                log(`âŒ API é€£æ¥å¤±æ•—: ${error.message}`, 'error');
                updateStatus('proxyStatus', 'âŒ é€£æ¥å¤±æ•—', 'error');

                if (error.message.includes('CORS')) {
                    log('âš ï¸ é€™æ˜¯ CORS éŒ¯èª¤ï¼Œä»£ç†é…ç½®å¯èƒ½æœ‰å•é¡Œ', 'warning');
                } else if (error.message.includes('Failed to fetch')) {
                    log('âš ï¸ ç¶²è·¯é€£æ¥éŒ¯èª¤ï¼Œå¾Œç«¯æœå‹™å¯èƒ½æœªé‹è¡Œ', 'warning');
                }
            }
        }

        // æ¨¡çµ„è¼‰å…¥æ¸¬è©¦
        async function testModuleLoad() {
            log('ğŸ“¦ é–‹å§‹æ¨¡çµ„è¼‰å…¥æ¸¬è©¦...', 'info');

            try {
                // æª¢æŸ¥å…¨å±€è®Šæ•¸
                if (typeof window.ROUTES !== 'undefined') {
                    log('âœ… ROUTES å…¨å±€è®Šæ•¸å­˜åœ¨', 'success');
                    log(`ğŸ“‹ ROUTES åŒ…å«: ${Object.keys(window.ROUTES).join(', ')}`, 'info');

                    // æª¢æŸ¥ API åŸºç¤é…ç½®
                    if (window.ROUTES.api && window.ROUTES.api.base !== undefined) {
                        log(`ğŸ”§ API åŸºç¤ URL: "${window.ROUTES.api.base}" (ç©ºå­—ç¬¦ä¸²è¡¨ç¤ºä½¿ç”¨ä»£ç†)`, 'info');
                    }
                } else {
                    log('âŒ ROUTES å…¨å±€è®Šæ•¸ä¸å­˜åœ¨', 'error');

                    // å¦‚æœä¸å­˜åœ¨ï¼Œå˜—è©¦è¼‰å…¥
                    try {
                        log('ğŸ”„ å˜—è©¦å‹•æ…‹è¼‰å…¥ Docker è·¯ç”±æ¨¡çµ„...', 'info');
                        await import('./src/js/config/routes-docker.js');

                        // å†æ¬¡æª¢æŸ¥
                        if (typeof window.ROUTES !== 'undefined') {
                            log('âœ… å‹•æ…‹è¼‰å…¥å¾Œå…¨å±€è®Šæ•¸å·²è¨­ç½®', 'success');
                        }
                    } catch (importError) {
                        log(`âš ï¸ å‹•æ…‹è¼‰å…¥å¤±æ•—: ${importError.message}`, 'warning');
                    }
                }

                if (typeof window.RouteUtils !== 'undefined') {
                    log('âœ… RouteUtils å…¨å±€è®Šæ•¸å­˜åœ¨', 'success');
                    log(`ğŸ”§ RouteUtils æ–¹æ³•: ${Object.keys(window.RouteUtils).join(', ')}`, 'info');
                } else {
                    log('âŒ RouteUtils å…¨å±€è®Šæ•¸ä¸å­˜åœ¨', 'error');
                }

                // æœ€çµ‚ç‹€æ…‹æª¢æŸ¥
                if (typeof window.ROUTES !== 'undefined' && typeof window.RouteUtils !== 'undefined') {
                    updateStatus('moduleStatus', 'âœ… æ¨¡çµ„æ­£å¸¸', 'success');
                } else {
                    updateStatus('moduleStatus', 'âš ï¸ éƒ¨åˆ†è¼‰å…¥', 'warning');
                }

                log('ğŸ“¦ æ¨¡çµ„è¼‰å…¥æ¸¬è©¦å®Œæˆ', 'success');

            } catch (error) {
                log(`âŒ æ¨¡çµ„è¼‰å…¥æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                updateStatus('moduleStatus', 'âŒ æ¸¬è©¦å¤±æ•—', 'error');
            }
        }

        // WebSocket æ¸¬è©¦
        function testWebSocket() {
            log('ğŸ”Œ é–‹å§‹ WebSocket æ¸¬è©¦...', 'info');

            try {
                // æ¸¬è©¦æ‡‰ç”¨ç¨‹å¼çš„ WebSocketï¼ˆé€éä»£ç†ï¼‰
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws`;
                const testType = 'Application WebSocket';

                log(`ğŸ“¡ æ¸¬è©¦æ‡‰ç”¨ç¨‹å¼ WebSocket: ${wsUrl}`, 'info');

                // æª¢æ¸¬ Vite é–‹ç™¼ç’°å¢ƒ
                const isViteDevMode = document.querySelector('script[src*="@vite/client"]') !== null;
                if (isViteDevMode) {
                    log('ğŸ”§ æª¢æ¸¬åˆ° Vite é–‹ç™¼ç’°å¢ƒ - HMR åŠŸèƒ½ç”± Vite è‡ªå‹•ç®¡ç†', 'info');
                    updateStatus('wsStatus', 'âœ… HMR æ­£å¸¸', 'success');
                }

                const ws = new WebSocket(wsUrl);

                ws.onopen = function() {
                    log('âœ… WebSocket é€£æ¥æˆåŠŸ', 'success');
                    updateStatus('wsStatus', 'âœ… é€£æ¥æ­£å¸¸', 'success');

                    // ç™¼é€æ¸¬è©¦æ¶ˆæ¯
                    ws.send(JSON.stringify({ type: 'ping', message: 'test' }));
                    log('ğŸ“¤ ç™¼é€æ¸¬è©¦æ¶ˆæ¯', 'info');

                    setTimeout(() => ws.close(), 1000);
                };

                ws.onmessage = function(event) {
                    log(`ğŸ“¥ æ”¶åˆ°æ¶ˆæ¯: ${event.data}`, 'success');
                };

                ws.onerror = function(error) {
                    log(`âŒ æ‡‰ç”¨ç¨‹å¼ WebSocket é€£æ¥å¤±æ•—: ${error.message || 'Connection failed'}`, 'error');

                    // æª¢æŸ¥æ˜¯å¦çœŸçš„æ˜¯éŒ¯èª¤ï¼Œé‚„æ˜¯åŠŸèƒ½æœªå¯¦ç¾
                    if (isViteDevMode) {
                        log('ğŸ’¡ é€™æ˜¯é–‹ç™¼ç’°å¢ƒï¼Œæ‡‰ç”¨ç¨‹å¼ WebSocket å¤±æ•—æ˜¯æ­£å¸¸çš„', 'warning');
                        log('   - å¾Œç«¯å¯èƒ½æœªå¯¦ç¾ WebSocket åŠŸèƒ½', 'warning');
                        log('   - é€™ä¸å½±éŸ¿åŸºæœ¬åŠŸèƒ½æ¸¬è©¦', 'warning');
                        updateStatus('wsStatus', 'âš ï¸ åŠŸèƒ½æœªå¯¦ç¾', 'warning');
                    } else {
                        log('ğŸ’¡ æ‡‰ç”¨ç¨‹å¼ WebSocket å¤±æ•—å¯èƒ½åŸå› :', 'warning');
                        log('   - å¾Œç«¯æœªå•Ÿç”¨ WebSocket æœå‹™', 'warning');
                        log('   - WebSocket ä»£ç†é…ç½®éŒ¯èª¤', 'warning');
                        updateStatus('wsStatus', 'âŒ é€£æ¥å¤±æ•—', 'error');
                    }
                };

                ws.onclose = function(event) {
                    log(`ğŸ”Œ WebSocket é€£æ¥å·²é—œé–‰ (code: ${event.code})`, 'info');
                    if (event.code !== 1000) {
                        log(`âš ï¸ éæ­£å¸¸é—œé–‰: ${event.reason || 'Unknown reason'}`, 'warning');
                    }
                };

                // 10ç§’å¾Œè¶…æ™‚
                setTimeout(() => {
                    if (ws.readyState === WebSocket.CONNECTING) {
                        ws.close();
                        log('â° WebSocket é€£æ¥è¶…æ™‚ (10ç§’)', 'warning');
                        updateStatus('wsStatus', 'â° é€£æ¥è¶…æ™‚', 'warning');
                    }
                }, 10000);

            } catch (error) {
                log(`âŒ WebSocket æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                updateStatus('wsStatus', 'âŒ æ¸¬è©¦å¤±æ•—', 'error');
            }
        }

        // é‹è¡Œå…¨éƒ¨æ¸¬è©¦
        async function runAllTests() {
            log('ğŸš€ é–‹å§‹é‹è¡Œå…¨éƒ¨æ¸¬è©¦...', 'info');
            clearLogs();
            log('ğŸš€ é–‹å§‹é‹è¡Œå…¨éƒ¨æ¸¬è©¦...', 'info');

            // é‡ç½®ç‹€æ…‹
            updateStatus('dockerStatus', 'æª¢æ¸¬ä¸­...', 'info');
            updateStatus('proxyStatus', 'æª¢æ¸¬ä¸­...', 'info');
            updateStatus('moduleStatus', 'æª¢æ¸¬ä¸­...', 'info');
            updateStatus('wsStatus', 'æª¢æ¸¬ä¸­...', 'info');

            // é †åºåŸ·è¡Œæ¸¬è©¦
            setTimeout(() => testBasicFunction(), 500);
            setTimeout(() => testApiConnection(), 1500);
            setTimeout(() => testModuleLoad(), 2500);
            setTimeout(() => testWebSocket(), 3500);

            setTimeout(() => {
                log('ğŸ‰ å…¨éƒ¨æ¸¬è©¦å®Œæˆï¼', 'success');
            }, 4500);
        }

        // å°èˆªåŠŸèƒ½
        function goToMain() {
            window.location.href = '/index.html';
        }

        function goToLogin() {
            window.location.href = '/src/pages/auth/login.html';
        }

        function goToDashboard() {
            window.location.href = '/src/pages/dashboard/index.html';
        }

        // æ›´æ–°æ™‚é–“
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent =
                `æ¸¬è©¦æ™‚é–“: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
        }

        // é è¼‰å…¥è·¯ç”±æ¨¡çµ„
        async function preloadRoutes() {
            try {
                log('ğŸ”„ é è¼‰å…¥ Docker è·¯ç”±æ¨¡çµ„...', 'info');
                await import('./src/js/config/routes-docker.js');
                log('âœ… è·¯ç”±æ¨¡çµ„é è¼‰å…¥æˆåŠŸ', 'success');

                // æª¢æŸ¥å…¨å±€è®Šæ•¸æ˜¯å¦å·²è¨­ç½®
                if (typeof window.ROUTES !== 'undefined' && typeof window.RouteUtils !== 'undefined') {
                    log('âœ… å…¨å±€è®Šæ•¸å·²æ­£ç¢ºè¨­ç½®', 'success');
                } else {
                    log('âš ï¸ å…¨å±€è®Šæ•¸è¨­ç½®å¯èƒ½æœ‰å•é¡Œ', 'warning');
                }
            } catch (error) {
                log(`âŒ è·¯ç”±æ¨¡çµ„é è¼‰å…¥å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // è‡ªå‹•åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            updateTime();
            setInterval(updateTime, 1000);

            log('ğŸ³ Docker æ¸¬è©¦é é¢è¼‰å…¥å®Œæˆ', 'success');

            // é è¼‰å…¥è·¯ç”±æ¨¡çµ„
            await preloadRoutes();

            log('ğŸ‘† è«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹æ¸¬è©¦', 'info');

            // è‡ªå‹•åŸ·è¡ŒåŸºæœ¬æ¸¬è©¦
            setTimeout(() => {
                testBasicFunction();
                testApiConnection();
            }, 1000);
        });

        // æš´éœ²å‡½æ•¸åˆ°å…¨å±€ä½œç”¨åŸŸ
        window.runAllTests = runAllTests;
        window.testBasicFunction = testBasicFunction;
        window.testApiConnection = testApiConnection;
        window.testModuleLoad = testModuleLoad;
        window.testWebSocket = testWebSocket;
        window.clearLogs = clearLogs;
        window.goToMain = goToMain;
        window.goToLogin = goToLogin;
        window.goToDashboard = goToDashboard;
    </script>
</body>
</html>
